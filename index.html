<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack + Contar Cartas Hi-Lo Mejorado</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
  :root {
    --bg-main: #1e1e2f;
    --bg-panel: #2c3e50;
    --text-main: #f0f0f5;
    --highlight: #f39c12;
    --green: #27ae60;
    --green-hover: #2ecc71;
    --red: #c0392b;
    --gray-disabled: #95a5a6;
    --shadow: rgba(0,0,0,0.7);
  }
  body {
    font-family: 'Roboto Mono', monospace, Arial, sans-serif;
    max-width: 520px;
    margin: 20px auto;
    background: var(--bg-main);
    color: var(--text-main);
    text-align: center;
    user-select: none;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  h1 {
    margin-bottom: 10px;
    color: var(--highlight);
    text-shadow: 0 0 8px var(--highlight);
  }
  #game {
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 20px 25px 40px;
    box-shadow: 0 8px 25px var(--shadow);
  }
  .hand {
    margin: 15px 0 0 0;
  }
  .hand h3 {
    margin: 0 0 6px 0;
    color: #ecf0f1;
    font-weight: 600;
  }
  .cards {
    font-size: 56px;
    min-height: 70px;
    display: flex;
    justify-content: center;
    gap: 12px;
    user-select: none;
    position: relative;
  }
  .card {
    background: linear-gradient(135deg, #fff 0%, #ddd 100%);
    border-radius: 8px;
    width: 60px;
    height: 86px;
    color: black;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 6px 8px;
    box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    font-weight: 700;
    font-size: 20px;
    position: relative;
    user-select: none;
    transition: transform 0.3s ease;
    overflow: hidden;
  }
  .card.red {
    color: var(--red);
  }
  .card img {
    pointer-events: none;
    user-select: none;
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 8px;
  }
  #controls {
    margin: 20px 0 10px;
  }
  button {
    font-size: 18px;
    padding: 10px 20px;
    margin: 0 10px 10px 10px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background-color: var(--green);
    color: white;
    box-shadow: 0 5px 10px rgba(39, 174, 96, 0.5);
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: var(--gray-disabled);
    box-shadow: none;
    cursor: default;
  }
  button:hover:not(:disabled) {
    background-color: var(--green-hover);
  }
  input[type="number"] {
    font-size: 18px;
    width: 100px;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    text-align: center;
    margin-bottom: 10px;
  }
  #feedback, #countFeedback, #balanceDisplay, #roundDisplay {
    margin-top: 12px;
    min-height: 28px;
    font-weight: 600;
  }
  #balanceDisplay {
    font-size: 20px;
    color: var(--highlight);
    user-select: none;
  }
  #roundDisplay {
    font-size: 16px;
    color: #ecf0f1aa;
    margin-bottom: 8px;
  }
  #countSection {
    margin-top: 20px;
    border-top: 1px solid #3b5160;
    padding-top: 18px;
  }
  /* PANEL LATERAL */
  #sidePanelToggle {
    position: fixed;
    top: 50%;
    right: 0;
    background: var(--green);
    border-radius: 8px 0 0 8px;
    padding: 10px 12px;
    cursor: pointer;
    user-select: none;
    z-index: 1000;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    transition: background-color 0.3s ease;
  }
  #sidePanelToggle:hover {
    background: var(--green-hover);
  }
  #sidePanel {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100%;
    background: var(--bg-panel);
    box-shadow: -5px 0 15px rgba(0,0,0,0.7);
    padding: 20px;
    overflow-y: auto;
    transition: right 0.3s ease;
    font-size: 14px;
    z-index: 999;
  }
  #sidePanel.open {
    right: 0;
  }
  #sidePanel h2 {
    margin-top: 0;
    color: var(--highlight);
    text-shadow: 0 0 6px var(--highlight);
    font-weight: 700;
    font-size: 22px;
  }
  .history-entry {
    margin-bottom: 16px;
    border-bottom: 1px solid #3b5160;
    padding-bottom: 10px;
  }
  .history-entry h3 {
    margin: 0 0 6px 0;
    font-weight: 600;
    color: #ecf0f1;
  }
  .history-cards {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
  }
  .history-cards .card {
    width: 40px;
    height: 58px;
    font-size: 14px;
    padding: 2px 4px;
  }
  .history-text {
    font-weight: 600;
    color: #ccc;
  }

  /* BOTONES DOBLAR y RENDIRSE */
  #btnDouble, #btnSurrender {
    background-color: #2980b9;
  }
  #btnDouble:hover:not(:disabled) {
    background-color: #3498db;
  }
  #btnSurrender {
    background-color: #e67e22;
  }
  #btnSurrender:hover:not(:disabled) {
    background-color: #d35400;
  }

  /* MODO DALTÓNICO */
  body.daltonic {
    --bg-main: #2b2b2b;
    --bg-panel: #3a3a3a;
    --text-main: #f0f0f0;
    --highlight: #f39c12;
    --green: #117a65;
    --green-hover: #16a085;
    --red: #922b21;
    --gray-disabled: #7f8c8d;
    --shadow: rgba(0,0,0,0.8);
  }
  body.daltonic .card.red {
    color: #0000ff; /* Azules para rojo */
  }
  /* ALTO CONTRASTE */
  body.highcontrast {
    background-color: black !important;
    color: yellow !important;
  }
  body.highcontrast #game {
    background-color: black !important;
    color: yellow !important;
  }
  body.highcontrast button {
    background-color: yellow !important;
    color: black !important;
    box-shadow: none !important;
  }
  body.highcontrast input[type="number"] {
    background-color: black !important;
    color: yellow !important;
    border: 2px solid yellow !important;
  }
  /* AJUSTE TAMAÑO */
  body.small-text {
    font-size: 12px;
  }
  body.large-text {
    font-size: 22px;
  }

  /* Animaciones cartas */
  .card.animate-deal {
    animation: dealCardAnim 0.4s ease forwards;
  }
  @keyframes dealCardAnim {
    0% {
      transform: translateY(-150%) rotate(-10deg) scale(0.5);
      opacity: 0;
      filter: drop-shadow(0 0 0 transparent);
    }
    100% {
      transform: translateY(0) rotate(0) scale(1);
      opacity: 1;
      filter: drop-shadow(2px 4px 4px rgba(0,0,0,0.4));
    }
  }
</style>
</head>
<body>
<h1>Blackjack + Contar Cartas Hi-Lo Mejorado</h1>

<div>
  <label for="initialBalanceInput">Saldo inicial ($): </label><br/>
  <input type="number" id="initialBalanceInput" min="1" max="100000" value="1000" />
  <button id="btnSetBalance">Establecer saldo</button>
</div>

<div id="game">
  <div id="balanceDisplay">Saldo: $1000</div>
  <div id="roundDisplay">Ronda: 0</div>

  <div>
    <label for="betInput">Apuesta esta ronda ($):</label><br/>
    <input type="number" id="betInput" min="1" max="1000" value="50" />
  </div>

  <div id="controls">
    <button id="btnStart">Empezar ronda</button>
    <button id="btnHit" disabled>Pedir</button>
    <button id="btnStand" disabled>Basta</button>
    <button id="btnDouble" disabled>Doblar apuesta</button>
    <button id="btnSurrender" disabled>Rendirse</button>
    <button id="btnEndSession" style="background:#c0392b;">Terminar sesión</button>
  </div>

  <div class="hand">
    <h3>Tu mano (<span id="playerSum">0</span>)</h3>
    <div id="playerCards" class="cards"></div>
  </div>

  <div class="hand">
    <h3>Mano de la banca (<span id="dealerSum">0</span>)</h3>
    <div id="dealerCards" class="cards"></div>
  </div>

  <div id="feedback"></div>

  <div id="countSection" style="display:none;">
    <label for="countInput">Ingresa el conteo acumulado Hi-Lo final de toda la sesión:</label><br/>
    <input type="number" id="countInput" />
    <button id="btnSubmitCount">Enviar conteo</button>
    <div id="countFeedback"></div>
  </div>
</div>

<!-- Panel lateral toggle -->
<div id="sidePanelToggle">Historial</div>
<!-- Panel lateral -->
<div id="sidePanel" aria-label="Historial de cartas y apuestas">
  <h2>Historial Rondas y Apuestas</h2>
  <div id="historyContainer"></div>
  <hr />
  <h3>Resumen acumulado</h3>
  <p id="summaryStats"></p>
</div>

<!-- Sonidos -->
<audio id="soundCard" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg" preload="auto"></audio>
<audio id="soundButton" src="https://actions.google.com/sounds/v1/buttons/button_click.ogg" preload="auto"></audio>

<!-- Accesibilidad -->
<div style="margin-top:20px;">
  <button id="btnToggleDaltonic" title="Activar/desactivar modo daltónico">Modo Daltónico</button>
  <button id="btnToggleContrast" title="Alternar alto contraste">Alto Contraste</button>
  <button id="btnTextSmall" title="Texto pequeño">A-</button>
  <button id="btnTextNormal" title="Texto normal">A</button>
  <button id="btnTextLarge" title="Texto grande">A+</button>
</div>

<script>
(() => {
  const deckRanks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  const deckSuits = ['spades', 'hearts', 'diamonds', 'clubs'];

  // Colores rojo para hearts y diamonds
  const redSuits = ['hearts', 'diamonds'];

  // Mapear símbolo unicode para mostrar en texto en algunas partes (opcional)
  const suitSymbols = {
    spades: '♠',
    hearts: '♥',
    diamonds: '♦',
    clubs: '♣'
  };

  // Hi-Lo counting values
  function hiLoValue(rank) {
    if(['2','3','4','5','6'].includes(rank)) return 1;
    if(['7','8','9'].includes(rank)) return 0;
    return -1;
  }

  // Blackjack card value
  function blackjackValue(rank) {
    if(['J','Q','K'].includes(rank)) return 10;
    if(rank === 'A') return 11;
    return parseInt(rank, 10);
  }

  // Construir dos mazos (52 cartas cada uno)
  let deck = [];
  function buildDeck() {
    deck = [];
    for(let deckNum=0; deckNum<2; deckNum++) { // dos mazos
      for(let suit of deckSuits) {
        for(let rank of deckRanks) {
          deck.push({rank, suit});
        }
      }
    }
  }

  // Mezclar mazos
  function shuffleDeck() {
    for(let i = deck.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
  }

  // Generar imagen base64 SVG para cada carta con diseño mejorado
  function cardToBase64SVG(card) {
    const {rank, suit} = card;
    const isRed = redSuits.includes(suit);

    // Formas SVG para cada palo con colores y estilo mejorado
    const suitSVGs = {
      spades: `<path fill="${isRed ? '#d32f2f' : '#000000'}" d="M30 10 L40 40 L20 40 Z" />
               <circle cx="30" cy="25" r="15" fill="${isRed ? '#d32f2f' : '#000000'}" />
               <rect x="27" y="40" width="6" height="20" fill="${isRed ? '#d32f2f' : '#000000'}" />`,
      hearts: `<path fill="#d32f2f" d="M30 15 C15 5, 10 25, 30 40 C50 25, 45 5, 30 15 Z" />`,
      diamonds: `<polygon fill="#d32f2f" points="30,10 40,30 30,50 20,30" />`,
      clubs: `<circle cx="30" cy="20" r="8" fill="#000000" />
              <circle cx="20" cy="35" r="8" fill="#000000" />
              <circle cx="40" cy="35" r="8" fill="#000000" />
              <rect x="27" y="40" width="6" height="20" fill="#000000" />`
    };

    // Definir color texto (rojo o negro)
    const textColor = isRed ? '#d32f2f' : '#000000';

    // SVG carta completa
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="86" viewBox="0 0 60 86">
      <defs>
        <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
          <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000000" flood-opacity="0.4"/>
        </filter>
      </defs>
      <rect width="60" height="86" rx="8" ry="8" fill="white" stroke="#999" stroke-width="1" filter="url(#shadow)"/>
      <text x="6" y="20" font-family="Roboto Mono, monospace" font-weight="700" font-size="18" fill="${textColor}">${rank}</text>
      <g transform="translate(10,40) scale(0.7)">
        ${suitSVGs[suit]}
      </g>
      <text x="54" y="80" font-family="Roboto Mono, monospace" font-weight="700" font-size="18" fill="${textColor}" transform="rotate(180 54,80)">${rank}</text>
      <g transform="translate(50,46) scale(0.7) rotate(180 10 10)">
        ${suitSVGs[suit]}
      </g>
    </svg>`;

    return 'data:image/svg+xml;base64,' + btoa(svg);
  }

  // Estado juego
  let playerCards = [];
  let dealerCards = [];
  let runningCount = 0; // total de TODAS las cartas sacadas en la sesión para Hi-Lo
  let balance = 1000;
  let bet = 50;
  let roundNumber = 0;
  let gameInProgress = false;
  let deckIndex = 0; // posición actual en el deck para sacar cartas
  let canDouble = false;
  let surrendered = false;

  // UI elementos
  const btnStart = document.getElementById('btnStart');
  const btnHit = document.getElementById('btnHit');
  const btnStand = document.getElementById('btnStand');
  const btnDouble = document.getElementById('btnDouble');
  const btnSurrender = document.getElementById('btnSurrender');
  const btnEndSession = document.getElementById('btnEndSession');

  const playerCardsDiv = document.getElementById('playerCards');
  const dealerCardsDiv = document.getElementById('dealerCards');
  const playerSumSpan = document.getElementById('playerSum');
  const dealerSumSpan = document.getElementById('dealerSum');
  const feedbackDiv = document.getElementById('feedback');
  const betInput = document.getElementById('betInput');
  const balanceDisplay = document.getElementById('balanceDisplay');
  const roundDisplay = document.getElementById('roundDisplay');

  const initialBalanceInput = document.getElementById('initialBalanceInput');
  const btnSetBalance = document.getElementById('btnSetBalance');

  const soundCard = document.getElementById('soundCard');
  const soundButton = document.getElementById('soundButton');

  const sidePanelToggle = document.getElementById('sidePanelToggle');
  const sidePanel = document.getElementById('sidePanel');
  const historyContainer = document.getElementById('historyContainer');
  const summaryStats = document.getElementById('summaryStats');

  const countSection = document.getElementById('countSection');
  const countInput = document.getElementById('countInput');
  const btnSubmitCount = document.getElementById('btnSubmitCount');
  const countFeedback = document.getElementById('countFeedback');

  const btnToggleDaltonic = document.getElementById('btnToggleDaltonic');
  const btnToggleContrast = document.getElementById('btnToggleContrast');
  const btnTextSmall = document.getElementById('btnTextSmall');
  const btnTextNormal = document.getElementById('btnTextNormal');
  const btnTextLarge = document.getElementById('btnTextLarge');

  // Historial completo (rondas)
  const roundsHistory = [];

  // Ajustar saldo
  btnSetBalance.addEventListener('click', () => {
    const val = parseInt(initialBalanceInput.value);
    if (isNaN(val) || val < 1 || val > 100000) {
      alert('Ingrese un saldo válido entre 1 y 100,000.');
      return;
    }
    balance = val;
    updateBalanceDisplay();
    resetGame();
  });

  function resetGame() {
    playerCards = [];
    dealerCards = [];
    runningCount = 0;
    roundNumber = 0;
    deckIndex = 0;
    gameInProgress = false;
    betInput.value = Math.min(balance, 50);
    feedbackDiv.textContent = '';
    playerCardsDiv.innerHTML = '';
    dealerCardsDiv.innerHTML = '';
    playerSumSpan.textContent = '0';
    dealerSumSpan.textContent = '0';
    roundsHistory.length = 0;
    updateHistoryUI();
    updateBalanceDisplay();
    roundDisplay.textContent = 'Ronda: 0';
    countSection.style.display = 'none';
    countInput.value = '';
    countFeedback.textContent = '';
    btnStart.disabled = false;
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
  }

  resetGame();

  // Iniciar ronda
  btnStart.addEventListener('click', () => {
    if (gameInProgress) return;
    bet = parseInt(betInput.value);
    if (isNaN(bet) || bet < 1) {
      feedbackDiv.textContent = 'Ingrese una apuesta válida.';
      return;
    }
    if (bet > balance) {
      feedbackDiv.textContent = 'No tienes saldo suficiente para esa apuesta.';
      return;
    }

    if(deck.length - deckIndex < 10){
      buildDeck();
      shuffleDeck();
      deckIndex = 0;
      runningCount = 0;
      feedbackDiv.textContent = 'Se mezclaron los mazos.';
    }

    roundNumber++;
    roundDisplay.textContent = 'Ronda: ' + roundNumber;
    gameInProgress = true;
    surrendered = false;

    playerCards = [];
    dealerCards = [];

    // Sacar cartas iniciales alternando jugador y dealer para realismo
    drawCardTo(playerCards, true);
    drawCardTo(dealerCards, true);
    drawCardTo(playerCards, true);
    drawCardTo(dealerCards, true);

    canDouble = true;

    updateUIAfterDraw();

    feedbackDiv.textContent = 'Tu turno: pide o basta.';
    btnStart.disabled = true;
    btnHit.disabled = false;
    btnStand.disabled = false;
    btnDouble.disabled = (balance < bet * 2);
    btnSurrender.disabled = false;

  });

  // Pedir carta
  btnHit.addEventListener('click', () => {
    if(!gameInProgress) return;
    drawCardTo(playerCards, true);
    canDouble = false;
    updateUIAfterDraw();
    if(getHandValue(playerCards) > 21){
      endRound('Te pasaste. Perdiste la apuesta.');
    }
  });

  // Basta
  btnStand.addEventListener('click', () => {
    if(!gameInProgress) return;
    // Turno dealer
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    dealerTurn();
  });

  // Doblar apuesta
  btnDouble.addEventListener('click', () => {
    if(!gameInProgress || !canDouble) return;
    if(balance < bet * 2) {
      feedbackDiv.textContent = 'No tienes saldo para doblar.';
      return;
    }
    bet *= 2;
    betInput.value = bet;
    drawCardTo(playerCards, true);
    updateUIAfterDraw();
    if(getHandValue(playerCards) > 21){
      endRound('Te pasaste. Perdiste la apuesta.');
      return;
    }
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    dealerTurn();
  });

  // Rendirse
  btnSurrender.addEventListener('click', () => {
    if(!gameInProgress) return;
    surrendered = true;
    endRound('Te rendiste. Pierdes la mitad de tu apuesta.', true);
  });

  // Terminar sesión
  btnEndSession.addEventListener('click', () => {
    if(gameInProgress){
      if(!confirm('Hay una ronda en curso. ¿Deseas terminar la sesión?')) return;
    }
    gameInProgress = false;
    btnStart.disabled = true;
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    feedbackDiv.textContent = 'Sesión finalizada. Ingresa el conteo Hi-Lo acumulado.';
    countSection.style.display = 'block';
  });

  // Enviar conteo Hi-Lo
  btnSubmitCount.addEventListener('click', () => {
    const userCount = parseInt(countInput.value);
    if(isNaN(userCount)){
      countFeedback.textContent = 'Ingrese un número válido.';
      return;
    }
    let diff = Math.abs(userCount - runningCount);
    if(diff === 0){
      countFeedback.textContent = '¡Perfecto! Conteo exacto.';
    } else if(diff <= 2){
      countFeedback.textContent = `Muy bien, tu conteo se acerca al real. Diferencia: ${diff}`;
    } else {
      countFeedback.textContent = `Diferencia grande. Conteo real: ${runningCount}.`;
    }
  });

  // Funciones principales

  function drawCardTo(hand, animate = false) {
    if(deckIndex >= deck.length){
      buildDeck();
      shuffleDeck();
      deckIndex = 0;
      runningCount = 0;
      feedbackDiv.textContent = 'Se mezclaron los mazos.';
    }
    const card = deck[deckIndex++];
    hand.push(card);
    runningCount += hiLoValue(card.rank);

    if(animate){
      // Sonido
      soundCard.currentTime = 0;
      soundCard.play();
    }
  }

  function getHandValue(hand) {
    let sum = 0;
    let aces = 0;
    for(let card of hand){
      const val = blackjackValue(card.rank);
      sum += val;
      if(card.rank === 'A') aces++;
    }
    while(sum > 21 && aces > 0){
      sum -= 10;
      aces--;
    }
    return sum;
  }

  // Mostrar cartas con animación
  function showCards(handDiv, hand) {
    handDiv.innerHTML = '';
    hand.forEach((card, i) => {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'card' + (redSuits.includes(card.suit) ? ' red' : '');
      // Insertar imagen SVG base64
      const img = document.createElement('img');
      img.src = cardToBase64SVG(card);
      img.alt = card.rank + ' de ' + card.suit;
      cardDiv.appendChild(img);

      // Animación
      cardDiv.classList.add('animate-deal');
      cardDiv.style.animationDelay = (i * 150) + 'ms';

      handDiv.appendChild(cardDiv);
    });
  }

  function updateUIAfterDraw() {
    showCards(playerCardsDiv, playerCards);
    showCards(dealerCardsDiv, dealerCards);
    playerSumSpan.textContent = getHandValue(playerCards);
    dealerSumSpan.textContent = getHandValue(dealerCards);
    updateBalanceDisplay();
    updateHistoryUI();

    btnDouble.disabled = !(canDouble && balance >= bet * 2);
  }

  function dealerTurn() {
    // Dealer saca mientras <= 16
    let dealerVal = getHandValue(dealerCards);
    while(dealerVal < 17){
      drawCardTo(dealerCards, true);
      updateUIAfterDraw();
      dealerVal = getHandValue(dealerCards);
    }

    const playerVal = getHandValue(playerCards);

    if(dealerVal > 21){
      endRound('La banca se pasó. Ganaste la apuesta!', false, true);
    } else if(dealerVal === playerVal){
      endRound('Empate. Recuperas tu apuesta.', false, true, true);
    } else if(dealerVal > playerVal){
      endRound('La banca gana. Perdiste la apuesta.');
    } else {
      endRound('Ganaste la apuesta!', false, true);
    }
  }

  // Terminar ronda con resultado y actualizar saldo
  function endRound(message, isSurrender=false, playerWon=false, isTie=false) {
    gameInProgress = false;
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    btnStart.disabled = false;

    let gain = 0;
    if(isSurrender) {
      gain = -Math.floor(bet / 2);
      balance += (bet + gain);
    } else if(isTie) {
      balance += bet; // apuesta devuelta
    } else if(playerWon){
      gain = bet;
      balance += bet * 2;
    } else {
      // Perdiste, apuestas ya descontadas al iniciar la ronda
    }

    feedbackDiv.textContent = message + (gain >= 0 ? ` Ganancia: $${gain}` : ` Pérdida: $${-gain}`);

    // Guardar historial ronda
    roundsHistory.push({
      round: roundNumber,
      bet,
      playerCards: [...playerCards],
      dealerCards: [...dealerCards],
      result: message,
      balanceAfter: balance,
      runningCount
    });

    updateBalanceDisplay();
    updateHistoryUI();

    // Reset apuesta para próxima ronda no mayor al saldo
    if(balance < bet){
      bet = balance;
      betInput.value = bet;
    }
  }

  function updateBalanceDisplay(){
    balanceDisplay.textContent = 'Saldo: $' + balance;
  }

  // Historial en panel lateral
  function updateHistoryUI(){
    historyContainer.innerHTML = '';
    roundsHistory.slice().reverse().forEach(round => {
      const div = document.createElement('div');
      div.className = 'history-entry';

      const title = document.createElement('h3');
      title.textContent = 'Ronda #' + round.round + ' | Apuesta: $' + round.bet;
      div.appendChild(title);

      const playerDiv = document.createElement('div');
      playerDiv.className = 'history-cards';
      round.playerCards.forEach(card => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card ' + (redSuits.includes(card.suit) ? 'red' : '');
        const img = document.createElement('img');
        img.src = cardToBase64SVG(card);
        img.alt = card.rank + ' de ' + card.suit;
        cardDiv.appendChild(img);
        playerDiv.appendChild(cardDiv);
      });
      div.appendChild(document.createTextNode('Jugador:'));
      div.appendChild(playerDiv);

      const dealerDiv = document.createElement('div');
      dealerDiv.className = 'history-cards';
      round.dealerCards.forEach(card => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card ' + (redSuits.includes(card.suit) ? 'red' : '');
        const img = document.createElement('img');
        img.src = cardToBase64SVG(card);
        img.alt = card.rank + ' de ' + card.suit;
        cardDiv.appendChild(img);
        dealerDiv.appendChild(cardDiv);
      });
      div.appendChild(document.createTextNode('Banca:'));
      div.appendChild(dealerDiv);

      const res = document.createElement('div');
      res.className = 'history-text';
      res.textContent = round.result + ` | Saldo: $${round.balanceAfter} | Conteo Hi-Lo: ${round.runningCount}`;
      div.appendChild(res);

      historyContainer.appendChild(div);
    });

    // Resumen stats simples
    summaryStats.textContent = `Rondas jugadas: ${roundsHistory.length} | Saldo actual: $${balance} | Conteo Hi-Lo actual: ${runningCount}`;
  }

  // Panel lateral toggle
  sidePanelToggle.addEventListener('click', () => {
    if(sidePanel.classList.contains('open')){
      sidePanel.classList.remove('open');
    } else {
      sidePanel.classList.add('open');
    }
  });

  // Accesibilidad botones

  btnToggleDaltonic.addEventListener('click', () => {
    document.body.classList.toggle('daltonic');
  });

  btnToggleContrast.addEventListener('click', () => {
    document.body.classList.toggle('highcontrast');
  });

  btnTextSmall.addEventListener('click', () => {
    document.body.classList.remove('large-text');
    document.body.classList.add('small-text');
  });

  btnTextNormal.addEventListener('click', () => {
    document.body.classList.remove('small-text');
    document.body.classList.remove('large-text');
  });

  btnTextLarge.addEventListener('click', () => {
    document.body.classList.remove('small-text');
    document.body.classList.add('large-text');
  });

  // Sonido botón
  [btnStart, btnHit, btnStand, btnDouble, btnSurrender, btnEndSession].forEach(btn => {
    btn.addEventListener('click', () => {
      soundButton.currentTime = 0;
      soundButton.play();
    });
  });

})();
</script>
</body>
</html>