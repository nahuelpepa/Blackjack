<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Blackjack + Contar Cartas Hi-Lo Mejorado</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');
  :root {
    --bg-main: #1e1e2f;
    --bg-panel: #2c3e50;
    --text-main: #f0f0f5;
    --highlight: #f39c12;
    --green: #27ae60;
    --green-hover: #2ecc71;
    --red: #c0392b;
    --gray-disabled: #95a5a6;
    --shadow: rgba(0,0,0,0.7);
  }
  body {
    font-family: 'Roboto Mono', monospace, Arial, sans-serif;
    max-width: 520px;
    margin: 20px auto;
    background: var(--bg-main);
    color: var(--text-main);
    text-align: center;
    user-select: none;
    transition: background-color 0.3s ease, color 0.3s ease;
  }
  h1 {
    margin-bottom: 10px;
    color: var(--highlight);
    text-shadow: 0 0 8px var(--highlight);
  }
  #game {
    background: var(--bg-panel);
    border-radius: 12px;
    padding: 20px 25px 40px;
    box-shadow: 0 8px 25px var(--shadow);
    position: relative;
  }
  .hand {
    margin: 15px 0 0 0;
  }
  .hand h3 {
    margin: 0 0 6px 0;
    color: #ecf0f1;
    font-weight: 600;
  }
  .cards {
    min-height: 100px;
    display: flex;
    justify-content: center;
    gap: 12px;
    user-select: none;
    position: relative;
  }
  .card {
    width: 60px;
    height: 90px;
    border-radius: 10px;
    background-color: white;
    box-shadow: 0 3px 8px rgba(0,0,0,0.4);
    position: relative;
    user-select: none;
    overflow: hidden;
    flex-shrink: 0;
    cursor: default;
    opacity: 1;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  .card img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    pointer-events: none;
    user-select: none;
  }
  #controls {
    margin: 20px 0 10px;
  }
  button {
    font-size: 18px;
    padding: 10px 20px;
    margin: 0 10px 10px 10px;
    cursor: pointer;
    border-radius: 8px;
    border: none;
    background-color: var(--green);
    color: white;
    box-shadow: 0 5px 10px rgba(39, 174, 96, 0.5);
    user-select: none;
    transition: background-color 0.3s ease;
  }
  button:disabled {
    background-color: var(--gray-disabled);
    box-shadow: none;
    cursor: default;
  }
  button:hover:not(:disabled) {
    background-color: var(--green-hover);
  }
  input[type="number"] {
    font-size: 18px;
    width: 100px;
    padding: 6px 10px;
    border-radius: 8px;
    border: none;
    text-align: center;
    margin-bottom: 10px;
  }
  #feedback, #countFeedback, #balanceDisplay, #roundDisplay, #trueCountDisplay {
    margin-top: 12px;
    font-weight: 600;
    user-select: none;
  }
  #balanceDisplay {
    font-size: 20px;
    color: var(--highlight);
  }
  #roundDisplay {
    font-size: 16px;
    color: #ecf0f1aa;
    margin-bottom: 8px;
  }
  #countSection {
    margin-top: 20px;
    border-top: 1px solid #3b5160;
    padding-top: 18px;
  }
  #trueCountDisplay {
    margin-top: 4px;
    font-size: 18px;
    color: #27ae60;
  }
  /* PANEL LATERAL */
  #sidePanelToggle {
    position: fixed;
    top: 50%;
    right: 0;
    background: var(--green);
    border-radius: 8px 0 0 8px;
    padding: 10px 12px;
    cursor: pointer;
    user-select: none;
    z-index: 1000;
    font-weight: 700;
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    transition: background-color 0.3s ease;
  }
  #sidePanelToggle:hover {
    background: var(--green-hover);
  }
  #sidePanel {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100%;
    background: var(--bg-panel);
    box-shadow: -5px 0 15px rgba(0,0,0,0.7);
    padding: 20px;
    overflow-y: auto;
    transition: right 0.3s ease;
    font-size: 14px;
    z-index: 999;
  }
  #sidePanel.open {
    right: 0;
  }
  #sidePanel h2 {
    margin-top: 0;
    color: var(--highlight);
    text-shadow: 0 0 6px var(--highlight);
    font-weight: 700;
    font-size: 22px;
  }
  .history-entry {
    margin-bottom: 16px;
    border-bottom: 1px solid #3b5160;
    padding-bottom: 10px;
  }
  .history-entry h3 {
    margin: 0 0 6px 0;
    font-weight: 600;
    color: #ecf0f1;
  }
  .history-cards {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
  }
  .history-cards .card {
    width: 36px;
    height: 54px;
  }
  /* BOTONES DOBLAR y RENDIRSE */
  #btnDouble, #btnSurrender {
    background-color: #2980b9;
  }
  #btnDouble:hover:not(:disabled) {
    background-color: #3498db;
  }
  #btnSurrender {
    background-color: #e67e22;
  }
  #btnSurrender:hover:not(:disabled) {
    background-color: #d35400;
  }
  /* MODO DALTÓNICO */
  body.daltonic {
    --bg-main: #2b2b2b;
    --bg-panel: #3a3a3a;
    --text-main: #f0f0f0;
    --highlight: #f39c12;
    --green: #117a65;
    --green-hover: #16a085;
    --red: #922b21;
    --gray-disabled: #7f8c8d;
    --shadow: rgba(0,0,0,0.8);
  }
  /* ALTO CONTRASTE */
  body.highcontrast {
    background-color: black !important;
    color: yellow !important;
  }
  body.highcontrast #game {
    background-color: black !important;
    color: yellow !important;
  }
  body.highcontrast button {
    background-color: yellow !important;
    color: black !important;
    box-shadow: none !important;
  }
  body.highcontrast input[type="number"] {
    background-color: black !important;
    color: yellow !important;
    border: 2px solid yellow !important;
  }
  /* AJUSTE TAMAÑO */
  body.small-text {
    font-size: 12px;
  }
  body.large-text {
    font-size: 22px;
  }
  /* Animaciones carta */
  @keyframes cardDeal {
    0% {
      transform: translate(0,0) scale(0.3);
      opacity: 0;
      z-index: 1000;
    }
    50% {
      opacity: 1;
      transform: translate(0, 0) scale(1.1);
    }
    100% {
      opacity: 1;
      transform: translate(0,0) scale(1);
    }
  }
</style>
</head>
<body>
<h1>Blackjack + Contar Cartas Hi-Lo Mejorado</h1>

<div>
  <label for="initialBalanceInput">Saldo inicial ($): </label><br/>
  <input type="number" id="initialBalanceInput" min="1" max="100000" value="1000" />
  <button id="btnSetBalance">Establecer saldo</button>
</div>

<div id="game">
  <div id="balanceDisplay">Saldo: $1000</div>
  <div id="roundDisplay">Ronda: 0</div>
  <div id="trueCountDisplay">True Count: 0.00</div>

  <div>
    <label for="betInput">Apuesta esta ronda ($):</label><br/>
    <input type="number" id="betInput" min="1" max="1000" value="50" />
  </div>

  <div id="controls">
    <button id="btnStart">Empezar ronda</button>
    <button id="btnHit" disabled>Pedir</button>
    <button id="btnStand" disabled>Basta</button>
    <button id="btnDouble" disabled>Doblar apuesta</button>
    <button id="btnSurrender" disabled>Rendirse</button>
    <button id="btnEndSession" style="background:#c0392b;">Terminar sesión</button>
  </div>

  <div class="hand">
    <h3>Tu mano (<span id="playerSum">0</span>)</h3>
    <div id="playerCards" class="cards"></div>
  </div>

  <div class="hand">
    <h3>Mano de la banca (<span id="dealerSum">0</span>)</h3>
    <div id="dealerCards" class="cards"></div>
  </div>

  <div id="feedback"></div>

  <div id="countSection" style="display:none;">
    <label for="countInput">Ingresa el conteo acumulado Hi-Lo final de toda la sesión:</label><br/>
    <input type="number" id="countInput" />
    <button id="btnSubmitCount">Enviar conteo</button>
    <div id="countFeedback"></div>
  </div>
</div>

<!-- Panel lateral toggle -->
<div id="sidePanelToggle">Historial</div>
<!-- Panel lateral -->
<div id="sidePanel" aria-label="Historial de cartas y apuestas">
  <h2>Historial Rondas y Apuestas</h2>
  <div id="historyContainer"></div>
  <hr />
  <h3>Resumen acumulado</h3>
  <p id="summaryStats"></p>
</div>

<!-- Sonidos -->
<audio id="soundCard" src="https://actions.google.com/sounds/v1/cartoon/slide_whistle_to_drum_hit.ogg" preload="auto"></audio>
<audio id="soundButton" src="https://actions.google.com/sounds/v1/buttons/button_click.ogg" preload="auto"></audio>

<!-- Accesibilidad -->
<div style="margin-top:20px;">
  <button id="btnToggleDaltonic" title="Activar/desactivar modo daltónico">Modo Daltónico</button>
  <button id="btnToggleContrast" title="Alternar alto contraste">Alto Contraste</button>
  <button id="btnTextSmall" title="Texto pequeño">A-</button>
  <button id="btnTextNormal" title="Texto normal">A</button>
  <button id="btnTextLarge" title="Texto grande">A+</button>
</div>

<script>
(() => {
  // --- Datos y funciones base ---
  const deckRanks = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
  const deckSuits = ['S', 'H', 'D', 'C']; // letras para los palos: S=spades, H=hearts, D=diamonds, C=clubs

  // Mapeo cartas a imágenes base64 (solo un par para ejemplo, agrega las que necesites)
  const cardImages = {
    "2S": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAAoCAYAAAAVmK7LAAAArklEQVRoQ+2XsQ3CMAyFXw1h6K7qL4H+zDcAzD9kXT2vZLmqmA0iY0RXyeeycOk5IrgCqY6OzAgnQA0u0LMFlmGd9gyC8qJ0ZJgj34krx8F10MgJuAlSvt4KZTPhrKSAZC8ckvNTo5T8QAqJ8AC7J7cpBzSuYO9I9cgsGRiEFxuLc7Uvh/HdMyq3f0VtfJQ+gRAXOqEMCPuIQAAAABJRU5ErkJggg==",
    "2H": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAAoCAYAAAAVmK7LAAAAXklEQVRoQ+2QwQmAMAxEafcLQX6a0LGvxC6JwMejSO8L6ZoBS20lydMHtkEUisSRIrNKUzqkNkBscqDTVMxw5lC0GkMY52HCnqBEizsGZNRuAFfZ5YapHM6cwL2wpYfDR3ACjZTytnT8EQqKN8OhoU7hCtN6zQLhKv7bE95V6N8AAAAASUVORK5CYII="
  };
  // Agrega aquí las demás cartas, o usa un patrón para generar la ruta (por ejemplo, si tienes un servidor)

  // Valores Hi-Lo
  function hiLoValue(rank) {
    if(['2','3','4','5','6'].includes(rank)) return 1;
    if(['7','8','9'].includes(rank)) return 0;
    return -1;
  }
  // Valor blackjack
  function blackjackValue(rank) {
    if(['J','Q','K'].includes(rank)) return 10;
    if(rank === 'A') return 11;
    return parseInt(rank, 10);
  }

  // Construir dos mazos juntos (104 cartas)
  let deck = [];
  function buildDeck() {
    deck = [];
    for(let d=0; d<2; d++){ // 2 mazos
      for(let suit of deckSuits) {
        for(let rank of deckRanks) {
          deck.push({rank, suit});
        }
      }
    }
  }

  function shuffleDeck() {
    for(let i = deck.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [deck[i], deck[j]] = [deck[j], deck[i]];
    }
  }

  // Estado juego
  let playerCards = [];
  let dealerCards = [];
  let runningCount = 0;
  let trueCount = 0;
  let playerSum = 0;
  let dealerSum = 0;
  let gameOver = false;
  let balance = 1000;
  let round = 0;
  let currentBet = 0;
  let totalWon = 0;
  let totalLost = 0;

  // Historial
  let roundsHistory = [];

  // DOM Elements
  const playerCardsDiv = document.getElementById('playerCards');
  const dealerCardsDiv = document.getElementById('dealerCards');
  const playerSumSpan = document.getElementById('playerSum');
  const dealerSumSpan = document.getElementById('dealerSum');
  const btnHit = document.getElementById('btnHit');
  const btnStand = document.getElementById('btnStand');
  const btnStart = document.getElementById('btnStart');
  const btnEndSession = document.getElementById('btnEndSession');
  const btnDouble = document.getElementById('btnDouble');
  const btnSurrender = document.getElementById('btnSurrender');
  const feedbackDiv = document.getElementById('feedback');
  const countInput = document.getElementById('countInput');
  const btnSubmitCount = document.getElementById('btnSubmitCount');
  const countFeedback = document.getElementById('countFeedback');
  const balanceDisplay = document.getElementById('balanceDisplay');
  const roundDisplay = document.getElementById('roundDisplay');
  const betInput = document.getElementById('betInput');
  const countSection = document.getElementById('countSection');
  const trueCountDisplay = document.getElementById('trueCountDisplay');
  const initialBalanceInput = document.getElementById('initialBalanceInput');
  const btnSetBalance = document.getElementById('btnSetBalance');
  const historyContainer = document.getElementById('historyContainer');
  const sidePanelToggle = document.getElementById('sidePanelToggle');
  const sidePanel = document.getElementById('sidePanel');
  const soundCard = document.getElementById('soundCard');
  const soundButton = document.getElementById('soundButton');

  // Accesibilidad botones
  const btnToggleDaltonic = document.getElementById('btnToggleDaltonic');
  const btnToggleContrast = document.getElementById('btnToggleContrast');
  const btnTextSmall = document.getElementById('btnTextSmall');
  const btnTextNormal = document.getElementById('btnTextNormal');
  const btnTextLarge = document.getElementById('btnTextLarge');

  // Animar cartas repartidas
  async function animateCardDeal(cardDiv, delay = 0) {
    cardDiv.style.opacity = '0';
    cardDiv.style.transform = 'scale(0.3) translateY(-20px)';
    await new Promise(r => setTimeout(r, delay));
    cardDiv.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
    cardDiv.style.opacity = '1';
    cardDiv.style.transform = 'scale(1) translateY(0)';
    soundCard.play();
    await new Promise(r => setTimeout(r, 300));
  }

  // Mostrar cartas (con imagen base64)
  function createCardElement(card) {
    const key = card.rank + card.suit;
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card';
    const img = document.createElement('img');
    img.alt = `${card.rank} de ${suitName(card.suit)}`;
    img.src = cardImages[key] || generatePlaceholderCard(card);
    cardDiv.appendChild(img);
    return cardDiv;
  }

  // Placeholder generico si no hay imagen (para que se vea la carta con texto)
  function generatePlaceholderCard(card) {
    // Crear un SVG básico en base64 con texto
    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="90">
      <rect width="60" height="90" fill="white" stroke="black" stroke-width="2" rx="10" ry="10"/>
      <text x="5" y="25" font-size="18" font-family="monospace" fill="black">${card.rank}</text>
      <text x="5" y="50" font-size="16" font-family="monospace" fill="black">${suitName(card.suit).slice(0,1)}</text>
    </svg>`;
    return "data:image/svg+xml;base64," + btoa(svg);
  }

  // Nombre del palo completo
  function suitName(suit) {
    switch(suit) {
      case 'S': return 'Picas';
      case 'H': return 'Corazones';
      case 'D': return 'Diamantes';
      case 'C': return 'Tréboles';
      default: return '';
    }
  }

  // Calcular suma mano considerando ases
  function calculateHandValue(cards) {
    let sum = 0;
    let aceCount = 0;
    for(let c of cards) {
      let val = blackjackValue(c.rank);
      sum += val;
      if(c.rank === 'A') aceCount++;
    }
    while(sum > 21 && aceCount > 0){
      sum -= 10;
      aceCount--;
    }
    return sum;
  }

  // Actualizar sumas y mostrar
  function updateSums() {
    playerSum = calculateHandValue(playerCards);
    dealerSum = calculateHandValue(dealerCards);
    playerSumSpan.textContent = playerSum;
    // Mostrar solo la primera carta de la banca en el inicio (cuando ronda activa)
    if(!gameOver){
      dealerSumSpan.textContent = blackjackValue(dealerCards[0]?.rank) || 0;
    } else {
      dealerSumSpan.textContent = dealerSum;
    }
  }

  // Actualizar balance en pantalla
  function updateBalanceDisplay() {
    balanceDisplay.textContent = `Saldo: $${balance}`;
  }

  // Barajar y construir mazo
  function resetDeck() {
    buildDeck();
    shuffleDeck();
    runningCount = 0;
  }

  // Repartir una carta (del mazo y actualizar contador)
  function dealCard() {
    if(deck.length === 0){
      resetDeck();
      addFeedback("Barajando mazos...");
    }
    const card = deck.pop();
    // Actualizar running count
    runningCount += hiLoValue(card.rank);
    updateTrueCount();
    return card;
  }

  // Actualizar True Count y mostrar
  function updateTrueCount() {
    const decksRemaining = Math.max(deck.length / 52, 1/52);
    trueCount = runningCount / decksRemaining;
    trueCountDisplay.textContent = `True Count: ${trueCount.toFixed(2)}`;
  }

  // Actualizar feedback texto
  function addFeedback(msg) {
    feedbackDiv.textContent = msg;
  }

  // Limpiar manos
  function clearHands() {
    playerCards = [];
    dealerCards = [];
    playerCardsDiv.innerHTML = '';
    dealerCardsDiv.innerHTML = '';
  }

  // Animar repartir cartas con delay entre ellas
  async function dealInitialCards() {
    clearHands();
    gameOver = false;
    updateSums();
    addFeedback("Repartiendo cartas...");
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    // Player: 2 cartas, Dealer: 2 cartas (una oculta)
    for(let i = 0; i < 2; i++){
      const cardP = dealCard();
      playerCards.push(cardP);
      const cardPDiv = createCardElement(cardP);
      playerCardsDiv.appendChild(cardPDiv);
      await animateCardDeal(cardPDiv, i*350);

      const cardD = dealCard();
      dealerCards.push(cardD);
      const cardDDiv = createCardElement(cardD);
      if(i === 0){
        dealerCardsDiv.appendChild(cardDDiv);
        await animateCardDeal(cardDDiv, i*350);
      } else {
        // Segunda carta del dealer tapada
        const backCardDiv = document.createElement('div');
        backCardDiv.className = 'card';
        backCardDiv.style.backgroundColor = '#111';
        backCardDiv.style.boxShadow = 'inset 0 0 10px black';
        backCardDiv.style.position = 'relative';
        backCardDiv.title = "Carta oculta";
        dealerCardsDiv.appendChild(backCardDiv);
      }
    }
    updateSums();
    btnHit.disabled = false;
    btnStand.disabled = false;
    btnDouble.disabled = false;
    btnSurrender.disabled = false;
    addFeedback("Tu turno: pide o basta.");
  }

  // Mostrar cartas del dealer ocultas
  function revealDealerCards() {
    dealerCardsDiv.innerHTML = '';
    for(let c of dealerCards){
      const cardDiv = createCardElement(c);
      dealerCardsDiv.appendChild(cardDiv);
    }
  }

  // Accion pedir carta
  async function playerHit() {
    if(gameOver) return;
    const card = dealCard();
    playerCards.push(card);
    const cardDiv = createCardElement(card);
    playerCardsDiv.appendChild(cardDiv);
    await animateCardDeal(cardDiv);

    updateSums();
    if(playerSum > 21){
      addFeedback("Te pasaste de 21, pierdes.");
      endRound(false);
    } else {
      addFeedback("Sigue jugando o basta.");
    }
  }

  // Acción basta
  async function playerStand() {
    if(gameOver) return;
    addFeedback("Turno de la banca...");
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;

    revealDealerCards();
    updateSums();

    // Dealer pide hasta 17
    while(dealerSum < 17){
      await new Promise(r => setTimeout(r, 800));
      const card = dealCard();
      dealerCards.push(card);
      const cardDiv = createCardElement(card);
      dealerCardsDiv.appendChild(cardDiv);
      await animateCardDeal(cardDiv);
      updateSums();
    }

    // Evaluar ganador
    if(dealerSum > 21 || playerSum > dealerSum){
      addFeedback("Ganaste esta ronda!");
      endRound(true);
    } else if(playerSum < dealerSum){
      addFeedback("Perdiste esta ronda.");
      endRound(false);
    } else {
      addFeedback("Empate (push).");
      endRound(null);
    }
  }

  // Doblar apuesta
  async function playerDouble() {
    if(gameOver) return;
    if(balance < currentBet){
      addFeedback("No tienes saldo suficiente para doblar.");
      return;
    }
    balance -= currentBet;
    currentBet *= 2;
    updateBalanceDisplay();
    addFeedback("Doblando apuesta y pidiendo carta...");
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    btnHit.disabled = true;
    btnStand.disabled = true;

    const card = dealCard();
    playerCards.push(card);
    const cardDiv = createCardElement(card);
    playerCardsDiv.appendChild(cardDiv);
    await animateCardDeal(cardDiv);

    updateSums();
    if(playerSum > 21){
      addFeedback("Te pasaste después de doblar.");
      endRound(false);
      return;
    }
    playerStand();
  }

  // Rendirse
  function playerSurrender() {
    if(gameOver) return;
    addFeedback("Te rendiste. Pierdes la mitad de la apuesta.");
    balance += currentBet / 2;
    updateBalanceDisplay();
    endRound(false);
  }

  // Terminar ronda
  function endRound(playerWon) {
    gameOver = true;
    revealDealerCards();
    updateSums();

    if(playerWon === true){
      balance += currentBet * 2;
      totalWon += currentBet;
    } else if(playerWon === false){
      totalLost += currentBet;
    } else {
      balance += currentBet; // Empate devuelve apuesta
    }

    updateBalanceDisplay();
    round++;
    roundDisplay.textContent = `Ronda: ${round}`;
    btnHit.disabled = true;
    btnStand.disabled = true;
    btnDouble.disabled = true;
    btnSurrender.disabled = true;
    btnStart.disabled = false;
    betInput.disabled = false;

    // Guardar historial
    roundsHistory.push({
      round,
      playerCards: playerCards.map(c => c.rank+c.suit),
      dealerCards: dealerCards.map(c => c.rank+c.suit),
      playerSum,
      dealerSum,
      playerWon,
      bet: currentBet,
      runningCount,
      trueCount
    });
    renderHistory();

    currentBet = 0;
  }

  // Renderizar historial
  function renderHistory() {
    historyContainer.innerHTML = '';
    for(let h of roundsHistory.slice().reverse()){
      const div = document.createElement('div');
      div.className = 'history-entry';
      div.innerHTML = `
        <h3>Ronda ${h.round} - Apuesta: $${h.bet}</h3>
        <div class="history-cards">${h.playerCards.map(c => {
          const imgSrc = cardImages[c] || generatePlaceholderCard({rank:c.slice(0,-1), suit:c.slice(-1)});
          return `<div class="card"><img src="${imgSrc}" alt="${c}" /></div>`;
        }).join('')}</div>
        <div class="history-cards">${h.dealerCards.map(c => {
          const imgSrc = cardImages[c] || generatePlaceholderCard({rank:c.slice(0,-1), suit:c.slice(-1)});
          return `<div class="card"><img src="${imgSrc}" alt="${c}" /></div>`;
        }).join('')}</div>
        <div>Jugador: ${h.playerSum} vs Banca: ${h.dealerSum}</div>
        <div>${h.playerWon === true ? '<b style="color:#27ae60">Ganó</b>' : (h.playerWon === false ? '<b style="color:#c0392b">Perdió</b>' : '<b>Empate</b>')}</div>
        <div>Running Count: ${h.runningCount.toFixed(2)} - True Count: ${h.trueCount.toFixed(2)}</div>
      `;
      historyContainer.appendChild(div);
    }
    const totalRounds = roundsHistory.length;
    const wins = roundsHistory.filter(r=>r.playerWon===true).length;
    const losses = roundsHistory.filter(r=>r.playerWon===false).length;
    const pushes = totalRounds - wins - losses;
    const summary = `
      Total rondas: ${totalRounds}<br/>
      Victorias: ${wins}<br/>
      Derrotas: ${losses}<br/>
      Empates: ${pushes}<br/>
      Total ganado: $${totalWon}<br/>
      Total perdido: $${totalLost}
    `;
    document.getElementById('summaryStats').innerHTML = summary;
  }

  // Inicio ronda
  async function startRound() {
    let bet = parseInt(betInput.value);
    if(isNaN(bet) || bet < 1){
      addFeedback("Ingresa una apuesta válida.");
      return;
    }
    if(bet > balance){
      addFeedback("No tienes saldo suficiente.");
      return;
    }
    currentBet = bet;
    balance -= bet;
    updateBalanceDisplay();
    betInput.disabled = true;
    btnStart.disabled = true;

    await dealInitialCards();
  }

  // Botón terminar sesión
  function endSession() {
    if(confirm("¿Quieres terminar la sesión? Se mostrará el resumen y se reseteará el juego.")){
      alert("Gracias por jugar. Se reseteará la sesión.");
      location.reload();
    }
  }

  // Toggle panel lateral
  sidePanelToggle.addEventListener('click', () => {
    sidePanel.classList.toggle('open');
  });

  // Botones accesibilidad
  btnToggleDaltonic.addEventListener('click', () => {
    document.body.classList.toggle('daltonic');
  });
  btnToggleContrast.addEventListener('click', () => {
    document.body.classList.toggle('highcontrast');
  });
  btnTextSmall.addEventListener('click', () => {
    document.body.classList.remove('large-text');
    document.body.classList.remove('normal-text');
    document.body.classList.add('small-text');
  });
  btnTextNormal.addEventListener('click', () => {
    document.body.classList.remove('large-text');
    document.body.classList.remove('small-text');
  });
  btnTextLarge.addEventListener('click', () => {
    document.body.classList.remove('small-text');
    document.body.classList.add('large-text');
  });

  // Eventos botones
  btnStart.addEventListener('click', () => {
    soundButton.play();
    startRound();
  });
  btnHit.addEventListener('click', () => {
    soundButton.play();
    playerHit();
  });
  btnStand.addEventListener('click', () => {
    soundButton.play();
    playerStand();
  });
  btnDouble.addEventListener('click', () => {
    soundButton.play();
    playerDouble();
  });
  btnSurrender.addEventListener('click', () => {
    soundButton.play();
    playerSurrender();
  });
  btnEndSession.addEventListener('click', () => {
    soundButton.play();
    endSession();
  });

  // Establecer saldo inicial
  btnSetBalance.addEventListener('click', () => {
    let val = parseInt(initialBalanceInput.value);
    if(isNaN(val) || val < 1){
      alert("Ingresa un saldo válido mayor que cero.");
      return;
    }
    balance = val;
    updateBalanceDisplay();
    round = 0;
    roundDisplay.textContent = "Ronda: 0";
    betInput.disabled = false;
    btnStart.disabled = false;
    roundsHistory = [];
    historyContainer.innerHTML = '';
    addFeedback("Saldo actualizado.");
  });

  // Enviar conteo final (opcional)
  btnSubmitCount.addEventListener('click', () => {
    const val = parseFloat(countInput.value);
    if(isNaN(val)){
      countFeedback.textContent = "Ingresa un número válido.";
      return;
    }
    if(Math.abs(val - runningCount) < 0.5){
      countFeedback.textContent = "Conteo correcto! Muy bien.";
    } else {
      countFeedback.textContent = `Conteo incorrecto. El real era ${runningCount.toFixed(2)}.`;
    }
  });

  // Inicializar
  resetDeck();
  updateBalanceDisplay();
  roundDisplay.textContent = "Ronda: 0";
  trueCountDisplay.textContent = "True Count: 0.00";
  addFeedback("Configura tu apuesta y pulsa empezar.");

})();
</script>

</body>
</html>